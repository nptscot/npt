---
title: "Utility trips methodology"
date: "Last updated: `r Sys.Date()`"
author: "Joey Talbot and Robin Lovelace"
format: gfm
execute: 
  echo: false
  message: false
---

```{r setup, include=FALSE}
library(tidyverse)
library(sf)
```

```{r}
#| include: false
#| label: import-nts
u = "https://assets.publishing.service.gov.uk/media/64e8b433635870000d1dbfbc/nts0403.ods"
f = basename(u)
if (!file.exists(f)) download.file(u, f)
readODS::ods_sheets(f)
nts0403_trips_excl_sw = readODS::read_ods(f, sheet = "NTS0403b_trips_excl_sw", skip = 5)
names(nts0403_trips_excl_sw)
#  [1] "Year"                                     
#  [2] "Commuting"                                
#  [3] "Business"                                 
#  [4] "Education"                                
#  [5] "Escort education"                         
#  [6] "Shopping"                                 
#  [7] "Other escort"                             
#  [8] "Personal business"                        
#  [9] "Visiting friends at private home"         
# [10] "Visiting friends elsewhere"               
# [11] "Entertainment or public activity"         
# [12] "Sport: participate"                       
# [13] "Holiday: base"                            
# [14] "Day trip"                                 
# [15] "Other including just walk"                
# [16] "All purposes"                             
# [17] "Unweighted sample size: individuals"      
# [18] "Unweighted sample size: trips (thousands)"
nts0403_length_raw = readODS::read_ods(f, sheet = "NTS0403e_trip_length", skip = 5)
names(nts0403_length_raw)
#  [1] "Year"                                     
#  [2] "Commuting"                                
#  [3] "Business"                                 
#  [4] "Education"                                
#  [5] "Escort education"                         
#  [6] "Shopping"                                 
#  [7] "Other escort"                             
#  [8] "Personal business"                        
#  [9] "Visiting friends at private home"         
# [10] "Visiting friends elsewhere"               
# [11] "Entertainment or public activity"         
# [12] "Sport: participate"                       
# [13] "Holiday: base"                            
# [14] "Day trip"                                 
# [15] "Other including just walk"                
# [16] "All purposes"                             
# [17] "Unweighted sample size: individuals"      
# [18] "Unweighted sample size: trips (thousands)"
```

## Trip numbers and purposes

We estimated trips for three everyday purposes (in addition to commuting and travel to school):

- shopping
- social (visiting friends and family)
- leisure

These are presented in a single network layer under the joint category of 'Other Everyday' trips.

We used data from England's National Travel Survey 2019 to estimate the total number of trips undertaken per person per day, as AADT. 
This gives an average of 953 trips per person per year, which equates to 2.61 trips per person per day. 
A trip is defined as a one-way course of travel from one place to another (https://www.gov.uk/government/statistics/national-travel-survey-2022-technical-report/national-travel-survey-2022-technical-report-glossary#trip).

Data on the number of trips per person per year is not available for Scotland after 2012 as far as we can tell.
The Scottish Household Survey only records travel on the day before the survey.
The National Travel Survey records travel patterns over an entire week.
However, for the ten year period from 2002/03 to 2011/12, the National Travel Survey recorded a mean of 995 trips per person per year by Scottish residents. 
In England, during 2002 to 2012, there were 1023 trips per person per year (https://assets.publishing.service.gov.uk/media/64e8b00063587000141dbfa6/nts0303.ods)

We assigned daily trips to trip purposes using the trip purpose percentage breakdown from the Scottish Household Survey, Table TD3 of the Transport and Travel in Scotland 2019 travel diary tables (after adjusting these percentages to remove the 'Go Home' category).
This results in 25.1% of trips being assigned for shopping, 11.7% for social, and 6.3% for leisure, compared with 23.3% for commuting (https://www.transport.gov.scot/media/51346/transport-and-travel-in-scotland-2019-travel-diary-tables.xlsx).

The roughly equivalent purposes in the National Travel Survey for 2022 are as follows:


```{r}
npt_nts_purpose_categories = tibble::tribble(
  ~`NPT purpose`, ~`NTS purpose`,
  "Shopping", "Shopping",
  "Social", "Visiting friends at private home",
  "Social", "Visiting friends elsewhere",
  "Leisure", "Entertainment or public activity",
  "Leisure", "Sport: participate"
)
npt_proportions = tibble::tribble(
  ~`NPT purpose`, ~Proportion,
  "Shopping", 0.251,
  "Social", 0.117,
  "Leisure", 0.063
)
# Get subset of NTS trip data from 2011 onwards:
nts0403_trips_percent = nts0403_trips_excl_sw |>
  select(Year:`All purposes`) |>
  # Convert to proportions of All purposes:
  mutate(across(-Year, ~ . / `All purposes`)) |>
  filter(Year > "2011") |>
  pivot_longer(-Year, names_to = "NTS purpose", values_to = "Proportion") |>
   filter(str_detect(`NTS purpose`, "Shop|Visit|Entertain"))
trips_percent_2022 = nts0403_trips_percent |>
  # Convert to % with scales::percent_format():
  filter(Year == "2022") |>
  select(`NTS purpose`, Proportion) |>
  left_join(npt_nts_purpose_categories, by = "NTS purpose")
trips_percent_2022 |>
  mutate(Proportion = scales::percent(Proportion, accuracy = 0.1)) |>
  knitr::kable()
```

Aggregating the NTS purposes to match the NPT purposes, we find that the mode split for the three everyday purposes in 2022 is as follows:

```{r}
trips_percent_2022 |>
  group_by(`NPT purpose`) |>
  summarise(`Proportion (NTS)` = sum(as.numeric(Proportion))) |>
  left_join(npt_proportions, by = "NPT purpose") |>
  transmute(
    `NPT purpose`,
    `Proportion (NTS)` = scales::percent(`Proportion (NTS)`, accuracy = 0.1),
    `Proportion (NPT)` = scales::percent(Proportion, accuracy = 0.1)
  ) |>
  knitr::kable()
```

The evolution of overall mode split from 2012 to 2022 in England is shown below:

```{r}
#| label: nts-trips-mode-split-time
# Line graph of trip purposes:
nts0403_trips_percent |>
  ggplot() +
  geom_line(aes(x = Year, y = Proportion, color = `NTS purpose`, group = `NTS purpose`)) +
  # x label at 45 degrees:
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  # integer x axis labels:
  scale_x_continuous(breaks = scales::pretty_breaks(n = 10)) +
  # % y axis labels:
  scale_y_continuous(labels = scales::percent_format(), limits = c(0, NA)) 
```

## Trip distances by purpose

Data on the distribution of trip distances (what % of trips are 0-2, 2-5 km etc) is important for the uptake model.
We took data from the National Travel Survey, shown below, as the basis of average trip lengths for the three everyday purposes, as shown in the table below.

```{r, include=FALSE}
nts0403_length = pivot_longer(nts0403_length_raw, -1, values_to = "Length (miles)", names_to = "NTS purpose") |>
  # Remove the space and everything after it:
    mutate(Year = str_remove(Year, " .+")) 
nts0403_length_subset = nts0403_length |>
  filter(Year > "2011") |>
  filter(str_detect(`NTS purpose`, "Commut|Shop|Visit|Edu|Entertain")) 
```

```{r}
#| label: nts-trips-length-time
plot_NTS_categories = nts0403_length_subset |>
  ggplot() +
  geom_line(aes(x = Year, y = `Length (miles)`, color = `NTS purpose`, group = `NTS purpose`)) +
  # x label at 45 degrees:
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ylim(c(0, NA))
lengths_npt = nts0403_length_subset |>
  filter(Year == "2022") |>
  left_join(npt_nts_purpose_categories, by = "NTS purpose") |>
  mutate(`NPT purpose` = case_when(
    is.na(`NPT purpose`) ~ `NTS purpose`,
    TRUE ~ `NPT purpose`
  ))
# Join with % trips:
lengths_npt = left_join(
  lengths_npt,
  trips_percent_2022 |> select(`NTS purpose`, Proportion),
  by = "NTS purpose"
) |>
  mutate(Proportion = case_when(
    is.na(Proportion) ~ 1,
    TRUE ~ `Length (miles)`
  )) |>
  group_by(`NPT purpose`) |>
  summarise(`Length (miles)` = weighted.mean(`Length (miles)`, Proportion)) 

lengths_npt = lengths_npt |>
    transmute(
      `NPT purpose`,
      `Length (miles)`,
      `Av (km)` = `Length (miles)` * 1.60934,
      `Average length (relative to commuting)` = `Length (miles)` / lengths_npt$`Length (miles)`[1]
      )

lengths_npt |>
    transmute(
      `NPT purpose`,
      `Average length (miles)` = `Length (miles)`,
      `Av (km)` = `Length (miles)` * 1.60934,
      `Average length (relative to commuting)` = `Length (miles)` / lengths_npt$`Length (miles)`[1]
      ) |>
  knitr::kable(digits = 2)
```

Lengths are expressed relative to the average commuting trip, the trip purpose for which we have the best data, allowing us to more effectively model trip distance distributions in different places (rural areas will tend to have longer trips for all trip purposes, for example), and allowing for the fact that absolute trip lengths vary.
Note: the assumption that the relative trip lengths are the same in Scotland as in England is a simplification and can be tested when more detailed data is available.

### Trip distance bands

Trip distance distributions by purpose are not available in open summaries of the Scottish Household Survey or National Travel Survey that we have seen.
We therefore use trip distance-frequency distributions for known commuting trips in Scotland, and adjust them based on the relative average trip lengths for the other purposes outlined above, to ensure realistic trip distance distributions for the other purposes.

The approach is illustrated in the graphs of trip distance distributions below:

```{r}
#| label: desire-lines-setup
#| include: false
targets::tar_source()
desire_lines_raw = read_TEAMS("secure_data/commute/commute_dl_sub30km.Rds")
breaks_dist = c(
  0,
  1,
  2,
  5,
  10,
  15,
  20,
  200
)
breaks_dist_labels = c(
  "0-1 km",
  "1-2 km",
  "2-5 km",
  "5-10 km",
  "10-15 km",
  "15-20 km",
  "20+ km"
)
diversion_factor = 1.3
breaks_dist_euclidean = breaks_dist / 
  diversion_factor # Assuming average circuity of 1.3
names(desire_lines_raw)
#  [1] "geo_code1"        "geo_code2"        "car"              "taxi"            
#  [5] "foot"             "bicycle"          "public_transport" "all"             
#  [9] "geometry"         "dist_euclidean" 
desire_lines = desire_lines_raw |>
  mutate(
    dist_euclidean = dist_euclidean / 1000,
    dist_band = cut(
      dist_euclidean,
      breaks = breaks_dist_euclidean,
      labels = breaks_dist_labels
    )
  )

# Check desire lines with NA dist_band:
sum(is.na(desire_lines$dist_band))
# # Look at them (they have distance of 0)
# desire_lines |>
#   filter(is.na(dist_band)) |>
#   pull(dist_euclidean) |>
#   head()

# Remove them:
desire_lines = desire_lines |>
  filter(!is.na(dist_band))
```

```{r}
#| label: desire-lines-dist-plot

# plot histogram of trip distances:
histogram_dist = desire_lines |>
  ggplot() +
  geom_histogram(aes(x = dist_euclidean, fill = dist_band), bins = 30) +
  scale_fill_viridis_d() +
  labs(
    x = "Trip distance (km)",
    y = "Number of desire lines"
  ) +
  xlim(c(1, 30))

histogram_dist

desire_line_summary = desire_lines |>
  group_by(dist_band) |>
  sf::st_drop_geometry() |>
  summarise(
    `Number of desire lines` = n(),
    `Number of trips (all)` = sum(all),
    `Proportion of trips` = sum(all) / sum(desire_lines$all),
    `Average distance (km)` = mean(dist_euclidean)
  ) 
# Barplot of the summary:
barplot_dist = desire_line_summary |>
  ggplot() +
  geom_col(aes(x = dist_band, y = `Proportion of trips`, fill = dist_band)) +
  scale_fill_viridis_d() +
  labs(
    x = "Trip distance band",
    y = "Proportion of trips"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = scales::percent_format())
barplot_dist

# With 1 km bins:
desire_line_summary_1km = desire_lines |>
  mutate(dist_band = cut(
    dist_euclidean,
    breaks = seq(0, 30, 1),
    labels = paste0(seq(0, 29), "-", seq(1, 30))
  )) |>
  group_by(dist_band) |>
  sf::st_drop_geometry() |>
  summarise(
    `Number of desire lines` = n(),
    `Number of trips (all)` = sum(all),
    `Proportion of trips` = sum(all) / sum(desire_lines$all),
    `Average distance (km)` = mean(dist_euclidean)
  )

# with number of trips from the all column of desire_lines:
# barplot_dist_number = desire_line_summary |>
#   ggplot() +
#   geom_col(aes(x = dist_band, y = `Number of trips (all)`, fill = dist_band)) +
#   scale_fill_viridis_d() +
#   labs(
#     x = "Trip distance band",
#     y = "Number of trips"
#   ) +
#   theme(axis.text.x = element_text(angle = 45, hjust = 1))

# # barplot_dist_number

# Expand the summary so the number of observations is proportional to the number of trips, with a total of 100 rows:
n_observations_per_band = round(desire_line_summary$`Proportion of trips` * 100)
expanded_summary = desire_line_summary |>
  slice(rep(1:n(), n_observations_per_band)) |>
  select(dist_band, `Average distance (km)`)
# tail(expanded_summary)
# table(expanded_summary$dist_band)
# table(expanded_summary$`Average distance (km)`)

# Histogram with Number of trips and distance bands
histogram_dist_number = expanded_summary |>
  ggplot() +
  geom_histogram(aes(x = `Average distance (km)`), breaks = breaks_dist_euclidean, fill = "blue") +
  labs(
    x = "Average trip distance (km)",
    y = "Number of trips"
  ) +
  xlim(c(0, 20))
# histogram_dist_number

```

We will model the number of trips as a function of distance using exponential decay, with the following functional form:

$$
N = \alpha \exp(d \beta)
$$

where $N$ is the number of trips, $d$ is the distance, and $\alpha$ and $\beta$ are parameters to be estimated.

Taking the log of both sides gives:

$$
\log(N) = \log(\alpha) + d \beta
$$

This allows us to model the number of trips as a linear function of distance, to estimate the decay parameter $\alpha$.
As shown in the graph below, this approach fits the data well:

```{r}
dd_data = desire_line_summary_1km |>
  transmute(
    average_distance = `Average distance (km)`,
    number_of_trips = `Number of trips (all)`,
    proportion = `Proportion of trips`
  )
dd_data_100km = tibble(average_distance = 100, number_of_trips = 1, proportion = 0)
dd_data_30_100km = purrr::map_dfr((31:100), ~ tibble(average_distance = .x, number_of_trips = 1, proportion = 0.0001))
dd_data = bind_rows(dd_data, dd_data_30_100km)
dd_data$log_n = log(dd_data$proportion)
# With lm function:
m1 = lm(log_n ~ average_distance, weights = number_of_trips, data = dd_data)
dd_data$m1 = predict(m1, newdata = dd_data) |>
  exp()
```

```{r}
#| label: desire-lines-dist-exp-decay
# Plot the number of trips with 1 km bins as scatter plot:
scatter_dist_number = desire_line_summary_1km |>
  ggplot() +
  geom_point(aes(x = `Average distance (km)`, y = `Proportion of trips`), color = "blue") +
  labs(
    x = "Trip distance (km)",
    y = "Proportion of trips"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_line(aes(x = average_distance, y = m1), data = dd_data, color = "red") +
  scale_y_continuous(labels = scales::percent_format())

scatter_dist_number
```

The value of $log(\alpha)$ and $\beta$ are estimated as follows:

```{r}
m1_coef = m1 |>
  coef()
```

Knowing the relative average trip lengths for the three everyday purposes, we can adjust the decay parameter $\beta$ to reflect the different trip lengths for the different purposes.
The modelled and empirical mean distances implied from the Scottish commute data above are shown in the table below:

```{r}
#| label: desire-lines-dist-modelled
mean_distance_observed = weighted.mean(dd_data$average_distance, dd_data$proportion) * diversion_factor
mean_distance_modelled = weighted.mean(dd_data$average_distance, dd_data$m1) * diversion_factor

purpose_distance_modelled = tibble::tribble(
  ~`NPT purpose`, ~`Average distance (km)`, ~`%1-2`, ~`%2-5`, 
  "Commuting (observed, up to 30km)", mean_distance_observed, dd_data$proportion[2], dd_data$proportion[3] + dd_data$proportion[4],
  "Commuting (modelled, up to 100km)", mean_distance_modelled, dd_data$m1[2], dd_data$m1[3] + dd_data$m1[4]
)
purpose_distance_modelled |>
  knitr::kable(digits = 2)  
```

After fitting $\beta$ parameters to ensure that the relative average trip lengths, the equivalent table, expanded for all trip purposes, is shown below:

```{r}
# Estimate beta for shopping trips as a starter:
mean_distance_shopping = lengths_npt |>
  filter(`NPT purpose` == "Shopping") |>
  pull(`Average length (relative to commuting)`) * mean_distance_modelled
# Create vector of values for beta, centered on the commuting value:
beta_commuting = m1_coef[2]
beta_values = rnorm(1000, beta_commuting, 0.1)

```

## Mode share

The mode shares were estimated using the mean mode shares from the Scottish Household Survey travel diaries in Table TD2 of Transport and Travel in Scotland 2019
(https://www.transport.gov.scot/media/51346/transport-and-travel-in-scotland-2019-travel-diary-tables.xlsx).
This gives mode shares (for social and leisure trips) of 1.2% for cycling, 22.1% for walking, 65.2% for car, 9.3% for public transport, and 2.2% for taxi/other.

For shopping, we assumed that the cycle mode share was half of this, with the mode share for the other modes (car, public transport, walking and taxi/other) increased accordingly. 
This follows our detailed analysis of Scottish Household Survey travel diaries, which identified shopping as having a considerably lower cycle mode share than other trip purposes.
Shopping trips can be more difficult to cycle, since they require carrying larger volumes of luggage.

## Trip origins and destinations

Origins and destinations were assigned based on Intermediate Zones.
The trip origins were assumed to be people's homes.
The number of trips originating from each zone is therefore a function of the residential population of the zone, multiplied by the AADT for the given trip purpose.

For shopping and leisure trips, we used Ordnance Survey Points of Interest (POIs) to identify potential trip destinations. 
All of these POIs were assigned to the nearest point on a 500m grid, giving a density index for each grid point.
The grid was clipped to avoid any destination points falling offshore.

The POIs for shopping comprised any location classed as 'Retail.' 
For leisure, they comprised locations classed as 'Sport and Entertainment.' 
This includes gyms, swimming pools, sports centres, nightclubs, cinemas, theatres, casinos and similar venues.
We chose this category because it matches the Scottish Household Survey 'Sport/Entertainment' trip purpose.  

For social trips, the destinations were people's homes, so the number of trips arriving in each zone was a function of the zone's residential population. 

## Spatial interaction model

We used a spatial interaction model to pair trip origins and destinations and thus create desire lines.
These are assigned according to a distance decay equation, which has been derived from distances of travel to work.
This may introduce bias if in reality typical trip distances for these other everyday purposes are different from the trip distances for commuting.

See NTS0403e for mean trip lengths by purpose
- shopping
- visiting friends at private home
- entertainment or public activity

## Disaggregating and filtering desire lines

The resulting desire lines are put through a jittering process.
In cases where the trip origins or destinations were assigned based on Intermediate Zone populations, we disaggregate these desire lines and assign them to randomised points on the road network of the zone, rather than using a single point for each zone. 
The disaggregation threshold is 100.

We then filter the desire lines, excluding those with a Euclidean distance of <500m (below this distance people are likely to walk rather than cycle) or >5km (to reduce the computational time of the routing).

## Routing

Finally, the desire lines are routed on the road network, using the CycleStreets routing algorithms for fast and quiet routes.
Individual routes are then combined into a route network.

