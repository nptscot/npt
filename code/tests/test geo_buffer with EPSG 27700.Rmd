---
output: github_document
---

```{r}
knitr::opts_chunk$set(eval = FALSE)
```



```{r}
remotes::install_dev("stplanr")
remotes::install_dev("rsgeo")
packageVersion("stplanr")
sf::sf_use_s2(TRUE)
library(stplanr)
library(dplyr)
library(sf)
library(mapview)
library(tmap)

rnet_x = sf::read_sf("https://github.com/nptscot/networkmerge/releases/download/v0.1/OS_large_route_network_example_edingurgh.geojson")
summary(duplicated(rnet_x$geometry))
rnet_y = sf::read_sf("https://github.com/nptscot/networkmerge/releases/download/v0.1/large_route_network_example_edingurgh.geojson")
rnet_x = st_zm(rnet_x, drop = TRUE, what = "ZM")
# rnet_xp = st_transform(rnet_x, 27700)
# rnet_yp = st_transform(rnet_y, "EPSG:27700")
```

Filter partial data spread over Scotland

```{r}
# Select points of interest:
points_of_interest = c(
  # "Stonoway", # uncomment for multiple areas
  "Thurso"
)
points_of_interest_sf = tmaptools::geocode_OSM(points_of_interest, as.sf = TRUE)
# 10km buffer around points of interest
buffer_sf = st_buffer(points_of_interest_sf, dist = 10000)
# Select features within the merged buffers
rnet_y_subset = rnet_y[buffer_sf, , op = sf::st_within]

# Union to speed-up buffer operation:
rnet_yu = st_union(rnet_y_subset)
# 30 m buffer with 10000 s2 cells
# ?s2::s2_buffer_cells()
rnet_yb = st_buffer(rnet_yu, dist = 50, max_cells = 10000)

rnet_x_subset = rnet_x[rnet_yb, , op = sf::st_within]
tmap_mode("plot")
tm_shape(rnet_x_subset) + tm_lines(col = "grey", lwd = 9) +
  tm_shape(rnet_y_subset) + tm_lines(col = "commute_fastest_bicycle_go_dutch")
```

Convert to projected geometry:

```{r}
rnet_xp = st_transform(rnet_x_subset, "EPSG:27700")
rnet_yp = st_transform(rnet_y_subset, "EPSG:27700")
```

```{r}
# Extract column names from the rnet_xp data frame
name_list = names(rnet_yp)
name_list
# Initialize an empty list
funs = list()

# Loop through each name and assign it a function based on specific conditions
for (name in name_list) {
  if (name == "geometry") {
    next  # Skip the current iteration
  } else if (name %in% c("Gradient", "Quietness")) {
    funs[[name]] = mean
  } else {
    funs[[name]] = sum
  }
}

```


```{r}
tmap_mode("view")

brks = c(0, 5, 10, 100)
# check size before merging:
nrow(rnet_xp)
nrow(rnet_yp)
rnet_x = sf::st_transform(rnet_xp, "EPSG:4326")
rnet_y = sf::st_transform(rnet_yp, "EPSG:4326")

rnet_merged = rnet_merge(rnet_x, rnet_y, dist = 20, segment_length = 10, funs = funs, max_angle_diff = 20, crs = "EPSG:27700") 
tm_shape(rnet_merged) +
  tm_lines(col = "commute_fastest_bicycle_go_dutch")

m1 = tm_shape(rnet_y) + tm_lines("all_fastest_bicycle", palette = "viridis", lwd = 5, breaks = brks)
m2 = tm_shape(rnet_merged) + tm_lines("all_fastest_bicycle", palette = "viridis", lwd = 5, breaks = brks)
tmap_arrange(m1, m2, sync = TRUE, nrow = 1)
```

Save for reproducible example:

```{r}
sf::write_sf(rnet_x, "rnet_x_thurso.geojson")
sf::write_sf(rnet_y, "rnet_y_thurso.geojson")
system("gh release list")
system("gh release create v2")
system("gh release upload v2 rnet_x_thurso.geojson")
system("gh release upload v2 rnet_y_thurso.geojson")

```

Full reproducible example:

```{r, eval=TRUE}
library(stplanr)
rnet_x = sf::read_sf("https://github.com/nptscot/npt/releases/download/v2/rnet_x_thurso.geojson")
rnet_y = sf::read_sf("https://github.com/nptscot/npt/releases/download/v2/rnet_y_thurso.geojson")

name_list = names(rnet_y)
funs = list()

# Loop through each name and assign it a function based on specific conditions
for (name in name_list) {
  if (name == "geometry") {
    next  # Skip the current iteration
  } else if (name %in% c("Gradient", "Quietness")) {
    funs[[name]] = mean
  } else {
    funs[[name]] = sum
  }
}

nrow(rnet_x)
nrow(rnet_y)

runtime = system.time({
  rnet_merged = rnet_merge(rnet_x, rnet_y, dist = 20, segment_length = 10, funs = funs, max_angle_diff = 20)
})
# Segments per second:
nrow(rnet_x) / runtime[3]
```

